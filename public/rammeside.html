<script src="http://cowi.mapcentia.com/js/openlayers/proj4js-combined.js"></script>
<script src="http://cowi.mapcentia.com/js/openlayers/defs/EPSG25832.js"></script>
<script src="http://mapcentia.github.io/esbjerg/code2map.js"></script>
<script src="http://esbjerg-kp18.mapcentia.com/api/v1/codes/ref?vn=ref_codes"></script>
<script src="http://esbjerg-kp18.mapcentia.com/api/v1/codes/field?vn=bind"></script>
<script>
    var gc2RammeMap = (function () {
        return {
            initTab: function (tabId) {
                if (!$('#pgtabcnt' + tabId).hasClass("tabOpen")) {
                    $('#pgtabcnt' + tabId).addClass('tabOpen');
                } else {
                    $('#pgtabcnt' + tabId).removeClass('tabOpen');
                }
            },
            init: function (enrid) {
                var bem = {
                    st_kp: "Revisionsdato",
                    enrid: "Nummmer",
                    enavn: "Navn",
                    h_an: "Hovedanvendelse",
                    r_an: "Rammeanvendelse",
                    r_an_txt: "Rammeanvendelse (Lang)",
                    st_zone: "Zonestatus",
                    pl_zone: "Planlagt zone",
                    pct: "Bebyggelsesprocent",
                    hem: "Højdebestemmelser",
                    fri: "Opholdsareal",
                    rkf: "Rækkefølge",
                    db: "Støj",
                    vvm: "VVM - Udvidet anvendelse",
                    auv: "Udvidet anvendelse",
                    auv1: "Udvidet anvendelse 1",
                    auv2: "Udvidet anvendelse 2",
                    auv3: "Udvidet anvendelse 3",
                    auv4: "Udvidet anvendelse 4",
                    res: "Reservation",
                    res1: "Reservation 1",
                    res2: "Reservation 2",
                    res3: "Reservation 3",
                    res4: "Reservation 4",
                    kva: "Kvalitetsbestemmelser",
                    kva1: "Kvalitetsbestemmelser 1",
                    kva2: "Kvalitetsbestemmelser 2",
                    kva3: "Kvalitetsbestemmelser 3",
                    kva4: "Kvalitetsbestemmelser 4"
                };
                var rules = {
                    rules: [
                        new OpenLayers.Rule({
                            filter: new OpenLayers.Filter.Comparison({
                                type: OpenLayers.Filter.Comparison.EQUAL_TO,
                                property: "h_an",
                                value: 'be'
                            }),
                            symbolizer: {
                                fillColor: "#990000",
                                fillOpacity: 0.8,
                                strokeColor: "#fff"
                            }
                        }),
                        new OpenLayers.Rule({
                            filter: new OpenLayers.Filter.Comparison({
                                type: OpenLayers.Filter.Comparison.EQUAL_TO,
                                property: "h_an",
                                value: 'bj'
                            }),
                            symbolizer: {
                                fillColor: "#d6c29e",
                                fillOpacity: 0.8,
                                strokeColor: "#fff"
                            }
                        }),
                        new OpenLayers.Rule({
                            filter: new OpenLayers.Filter.Comparison({
                                type: OpenLayers.Filter.Comparison.EQUAL_TO,
                                property: "h_an",
                                value: 'bl'
                            }),
                            symbolizer: {
                                fillColor: "#b85252",
                                fillOpacity: 0.8,
                                strokeColor: "#fff"
                            }
                        }),
                        new OpenLayers.Rule({
                            filter: new OpenLayers.Filter.Comparison({
                                type: OpenLayers.Filter.Comparison.EQUAL_TO,
                                property: "h_an",
                                value: 'ca'
                            }),
                            symbolizer: {
                                fillColor: "#bf00f2",
                                fillOpacity: 0.8,
                                strokeColor: "#fff"
                            }
                        }),
                        new OpenLayers.Rule({
                            filter: new OpenLayers.Filter.Comparison({
                                type: OpenLayers.Filter.Comparison.EQUAL_TO,
                                property: "h_an",
                                value: 'cb'
                            }),
                            symbolizer: {
                                fillColor: "#9954bf",
                                fillOpacity: 0.8,
                                strokeColor: "#fff"
                            }
                        }),
                        new OpenLayers.Rule({
                            filter: new OpenLayers.Filter.Comparison({
                                type: OpenLayers.Filter.Comparison.EQUAL_TO,
                                property: "h_an",
                                value: 'cl'
                            }),
                            symbolizer: {
                                fillColor: "#cca8e0",
                                fillOpacity: 0.8,
                                strokeColor: "#fff"
                            }
                        }),
                        new OpenLayers.Rule({
                            filter: new OpenLayers.Filter.Comparison({
                                type: OpenLayers.Filter.Comparison.EQUAL_TO,
                                property: "h_an",
                                value: 'cm'
                            }),
                            symbolizer: {
                                fillColor: "#660099",
                                fillOpacity: 0.8,
                                strokeColor: "#fff"
                            }
                        }),
                        new OpenLayers.Rule({
                            filter: new OpenLayers.Filter.Comparison({
                                type: OpenLayers.Filter.Comparison.EQUAL_TO,
                                property: "h_an",
                                value: 'ef'
                            }),
                            symbolizer: {
                                fillColor: "#2566d9",
                                fillOpacity: 0.8,
                                strokeColor: "#fff"
                            }
                        }),
                        new OpenLayers.Rule({
                            filter: new OpenLayers.Filter.Comparison({
                                type: OpenLayers.Filter.Comparison.EQUAL_TO,
                                property: "h_an",
                                value: 'eh'
                            }),
                            symbolizer: {
                                fillColor: "#bfe8ff",
                                fillOpacity: 0.8,
                                strokeColor: "#fff"
                            }
                        }),
                        new OpenLayers.Rule({
                            filter: new OpenLayers.Filter.Comparison({
                                type: OpenLayers.Filter.Comparison.EQUAL_TO,
                                property: "h_an",
                                value: 'eo'
                            }),
                            symbolizer: {
                                fillColor: "#8cb3ed",
                                fillOpacity: 0.8,
                                strokeColor: "#fff"
                            }
                        }),
                        new OpenLayers.Rule({
                            filter: new OpenLayers.Filter.Comparison({
                                type: OpenLayers.Filter.Comparison.EQUAL_TO,
                                property: "h_an",
                                value: 'la'
                            }),
                            symbolizer: {
                                fillColor: "#e6e6b3",
                                fillOpacity: 0.8,
                                strokeColor: "#fff"
                            }
                        }),
                        new OpenLayers.Rule({
                            filter: new OpenLayers.Filter.Comparison({
                                type: OpenLayers.Filter.Comparison.EQUAL_TO,
                                property: "h_an",
                                value: 'lb'
                            }),
                            symbolizer: {
                                fillColor: "#996666",
                                fillOpacity: 0.8,
                                strokeColor: "#fff"
                            }
                        }),
                        new OpenLayers.Rule({
                            filter: new OpenLayers.Filter.Comparison({
                                type: OpenLayers.Filter.Comparison.EQUAL_TO,
                                property: "h_an",
                                value: 'na'
                            }),
                            symbolizer: {
                                fillColor: "#bfd18c",
                                fillOpacity: 0.8,
                                strokeColor: "#fff"
                            }
                        }),
                        new OpenLayers.Rule({
                            filter: new OpenLayers.Filter.Comparison({
                                type: OpenLayers.Filter.Comparison.EQUAL_TO,
                                property: "h_an",
                                value: 'of'
                            }),
                            symbolizer: {
                                fillColor: "#ffff73",
                                fillOpacity: 0.8,
                                strokeColor: "#fff"
                            }
                        }),
                        new OpenLayers.Rule({
                            filter: new OpenLayers.Filter.Comparison({
                                type: OpenLayers.Filter.Comparison.EQUAL_TO,
                                property: "h_an",
                                value: 'og'
                            }),
                            symbolizer: {
                                fillColor: "#80b340",
                                fillOpacity: 0.8,
                                strokeColor: "#fff"
                            }
                        }),
                        new OpenLayers.Rule({
                            filter: new OpenLayers.Filter.Comparison({
                                type: OpenLayers.Filter.Comparison.EQUAL_TO,
                                property: "h_an",
                                value: 're'
                            }),
                            symbolizer: {
                                fillColor: "#d9ff99",
                                fillOpacity: 0.8,
                                strokeColor: "#fff"
                            }
                        }),
                        new OpenLayers.Rule({
                            filter: new OpenLayers.Filter.Comparison({
                                type: OpenLayers.Filter.Comparison.EQUAL_TO,
                                property: "h_an",
                                value: 'so'
                            }),
                            symbolizer: {
                                fillColor: "#fea601",
                                fillOpacity: 0.8,
                                strokeColor: "#fff"
                            }
                        }),
                        new OpenLayers.Rule({
                            filter: new OpenLayers.Filter.Comparison({
                                type: OpenLayers.Filter.Comparison.EQUAL_TO,
                                property: "h_an",
                                value: 'ta'
                            }),
                            symbolizer: {
                                fillColor: "#8A8A8A",
                                fillOpacity: 0.8,
                                strokeColor: "#fff"
                            }
                        })
                    ]
                };
                var styleMap = new OpenLayers.StyleMap({
                    "default": new OpenLayers.Style({
                                fillColor: "#ffffff",
                                fillOpacity: 0.0,
                                strokeColor: "#00aa00",
                                strokeWidth: 2,
                                graphicZIndex: 1
                            }, rules
                    ),
                    "temporary": new OpenLayers.Style({
                                fillColor: "#ffffff",
                                fillOpacity: 0.0,
                                strokeColor: "#00aa00",
                                strokeWidth: 2,
                                graphicZIndex: 1
                            }, rules
                    )
                });
                var map = new mygeocloud_ol.map("map", "esbjerg");
                map.addBaseLayer("dtkSkaermkortDaempet");
                var store = new mygeocloud_ol.geoJsonStore("esbjerg", {
                    sql: "SELECT * FROM kommuneplan18.kpplandk2_view_bind WHERE enrid='" + enrid + "'",
                    lifetime: 0,
                    styleMap: styleMap,
                    clientEncoding: "UTF8",
                    onLoad: function () {
                        map.zoomToExtentOfgeoJsonStore(this);
                        setTimeout(function () {
                            c.select(store.layer.features[0]);
                        }, 100);


                    }
                });
                map.addGeoJsonStore(store);
                store.load();
                var c = new OpenLayers.Control.SelectFeature(
                        store.layer, {
                            hover: false,
                            highlightOnly: false,
                            clickout: true,
                            renderIntent: "temporary",
                            onSelect: function (e) {
                                var layer = e, sp, strBind, body, layersForLink = [],
                                        bounds = layer.geometry.bounds;
                                var source = new Proj4js.Proj("EPSG:900913");    //source coordinates will be in Longitude/Latitude
                                var dest = new Proj4js.Proj("EPSG:25832");
                                var p1 = new Proj4js.Point(bounds.left, bounds.bottom);
                                Proj4js.transform(source, dest, p1);
                                var p2 = new Proj4js.Point(bounds.right, bounds.top);
                                Proj4js.transform(source, dest, p2);

                                if (layer.attributes) {
                                    var strBem = "";
                                    strBem += "<h2>Bestemmelser</h2><table  border='1' class='table table-condensed table-striped table-responsive'>";
                                    $.each(bem, function (i, v) {

                                        if (layer.attributes[i] !== undefined && layer.attributes[i] !== null && ref_codes[layer.attributes[i]] !== "Ingen" && layer.attributes[i] !== "") {

                                            sp = (ref_codes[layer.attributes[i]] !== undefined) ? ref_codes[layer.attributes[i]].split("|") : [layer.attributes[i]];

                                            if (sp.length > 1 && sp[0] !== "") {

                                                v = sp[0];
                                                body = sp[1];
                                            }
                                            else if (sp.length > 1) {
                                                body = sp[1];
                                            }
                                            else {
                                                body = ref_codes[layer.attributes[i]] || layer.attributes[i];
                                            }
                                            strBem += "<tr><td style='width: 50%'>" + v + "</td><td>" + body + "</td></tr>";
                                        }
                                    });
                                    strBem += "</table>";
                                    $("#info-bem").html(strBem);

                                    strBind = "<h2>Bindninger</h2><table border='1' class='table table-condensed table-striped table-responsive'>";
                                    $.each(bind, function (i, v) {

                                        if (layer.attributes.bindninger[i] !== undefined && layer.attributes.bindninger[i] !== null && ref_codes[layer.attributes[i]] !== "Ingen" && layer.attributes[i] !== "") {
                                            console.log(v)

                                            sp = (ref_codes[layer.attributes.bindninger[i]] !== undefined) ? ref_codes[layer.attributes.bindninger[i]].split("|") : [layer.attributes.bindninger[i]];

                                            if (sp.length > 1 && sp[0] !== "") {
                                                v = "<span style='color: #000000'>" + sp[0] + "</span>";
                                                body = sp[1];
                                            }
                                            else if (sp.length > 1) {
                                                body = sp[1];
                                            }
                                            else {
                                                body = ref_codes[layer.attributes.bindninger[i]] || layer.attributes.bindninger[i];
                                            }
                                            if (i === "db_bi") {
                                                var dbArr = ["db_jb", "db_lh", "db_mb", "db_sk", "db_vejk", "db_vej", "db_vind", "db_virk"];
                                                $.each(dbArr, function (x, db) {
                                                    if (layer.attributes.bindninger[db] !== undefined && layer.attributes.bindninger[db] !== null && layer.attributes.bindninger[db] !== "Ingen") {
                                                        body = body + "<br>" + ref_codes[layer.attributes.bindninger[db]].split("|")[1];
                                                    }
                                                })
                                            }
                                            strBind += "<tr><td style='width: 50%'>" + v + " (" + i +  ")</td><td>" + body + "</td></tr>";

                                        }
                                    });
                                    layersForLink.push("theme-gst-dtkskaerm-sh");
                                    layersForLink.push("theme-planer_rammer_kp14_ha");
                                    strBind += "</table>";
                                    $("#info-bind").html(strBind);


                                    strBind = "<div id=\"pgtabitem\" class=\"pgtabitem gradient\"><div class=\"pgtabheader\"><a href=\"Javascript:void(0)\" onclick=\"gc2RammeMap.initTab('bind')\">Bindninger som ikke blev fundet</a></div><div id=\"pgtabcntbind\" class=\"pgtabcontent\"><table class=\"table table-condensed table-striped table-responsive\">";
                                    strBind += "<table class='table table-condensed table-striped table-responsive'>";
                                    $.each(bind, function (i, v) {

                                        if (layer.attributes.bindninger[i] === undefined || layer.attributes.bindninger[i] === null || ref_codes[layer.attributes.bindninger[i]] === "Ingen" || layer.attributes.bindninger[i] === "") {
                                            strBind += "<tr><td style='width: 50%'>" + v + " (" + i +  ")</td><td>" + "Ingen" + "</td></tr>";
                                        }

                                    });
                                    strBind += "</table>";
                                    strBind += "</div></div>";
                                    $("#info-bind-null").html(strBind);
                                    var mapUrl = "http://webkort.esbjergkommune.dk/cbkort?selectorgroups=themecontainer%20baggrundskort&mapext=" + p1.x + " " + p1.y + " " + p2.x + " " + p2.y + "&layers=" + layersForLink.join(" ") + "&profile=borger_kommuneplan"
                                    var strMap = "<div style='float: left' id='pdf-link'></div><div style='float: right'><a target='_blank' href='" + mapUrl + "'>Link til WebKort med bindinger</a></div>";
                                    $("#info-map").html(strMap);
                                    $("#pdf-link").html('<a target="_blank" href="http://www.html2pdf.it/?url=http://kommuneplan.esbjergkommune.dk/dk/uden-layout/pdf.htm?enrid=' + enrid + '&format=A4&orientation=portrait&margin=1cm">Link til PDF</a>')
                                }
                            }
                        }
                );
                map.addControl(c);
            }
        }
    }());
</script>
<script src='http://cowi.mapcentia.com/js/openlayers/OpenLayers.js'></script>
<script src='http://cowi.mapcentia.com/api/v1/js/api.js'></script>
<div id="map" style="width:100%">
    <div class="alert alert-info" id="label"
         style="display:none;padding:3px;z-index: 1000;position: absolute;border:1px solid silver;background-color:#FFFF99"></div>
</div>
<div id="info-map"></div>
<div id="info-bem" style="clear: both; margin-top:50px"></div>
<div id="info-bind"></div>
<div id="info-bind-null"></div>


<script>
    gc2RammeMap.init(mygeocloud_ol.urlVars.enrid);
</script>